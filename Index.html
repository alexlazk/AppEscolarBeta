<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title><?= initial.settings.SCHOOL_NAME || 'Recicla App' ?></title>

  <style>
    :root{
      --primary:#eb1946;
      --primary-dark:#c2173a;
      --secondary:#00293f;
      --accent:#f9dce3;
      --bg:#f6f8fb;
      --surface:#ffffff;
      --surface-soft:#fdf2f5;
      --text:#17212b;
      --muted:#516073;
      --border:#e1e7ef;
      --radius:16px;
      --shadow:0 16px 40px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.5;color:var(--text);background:linear-gradient(180deg,#ffffff 0%,#f6f8fb 65%);-webkit-font-smoothing:antialiased;font-size:clamp(15px,1.6vw,18px)}
    .app-header{display:flex;gap:16px;align-items:center;padding:14px 20px;background:linear-gradient(110deg,var(--primary) 0%,var(--primary-dark) 70%);box-shadow:var(--shadow);position:sticky;top:0;z-index:20;color:#fff}
    .logo{display:flex;align-items:center}
    .logo img{height:52px;width:auto}
    .title h1{font-size:1.1rem;margin:0;color:#fff}
    .title small{display:block;margin-top:4px;font-size:.85rem;color:rgba(255,255,255,.82)}
    main.container{padding:24px 20px calc(110px + env(safe-area-inset-bottom));max-width:1040px;margin:0 auto;display:grid;gap:24px}
    .card{background:var(--surface);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow);border:1px solid var(--border);display:flex;flex-direction:column;gap:16px}
    .card.soft{background:var(--surface-soft);border-color:rgba(235,25,70,.25)}
    .card h2{margin:0;font-size:1.45em;line-height:1.25}
    .card h3{margin:0;font-size:1.25em;line-height:1.3}
    .hidden{display:none}.btn{appearance:none;border:none;border-radius:14px;padding:12px 18px;background:var(--accent);color:var(--primary);cursor:pointer;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:transform .2s,box-shadow .2s,background .2s,color .2s}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.outline{background:transparent;color:var(--primary);border:1px solid rgba(235,25,70,.4)}
    .btn.outline:hover{background:rgba(235,25,70,.08);box-shadow:none;transform:none}
    .btn:hover{box-shadow:0 10px 26px rgba(235,25,70,.2);transform:translateY(-1px)}
    .btn:active{transform:translateY(0);box-shadow:none}
    .btn:focus-visible{outline:3px solid rgba(235,25,70,.35);outline-offset:2px}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:8px 0 8px}
    .form-row{display:flex;gap:10px;align-items:flex-end;margin-bottom:12px}
    label{font-size:14px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
    input{padding:12px 14px;border:1px solid var(--border);border-radius:12px;outline:0;font-size:1rem;background:#fff;transition:border .2s,box-shadow .2s}
    input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(235,25,70,.16)}
    .grid-2{display:grid;grid-template-columns:1fr;gap:20px}
    @media(min-width:960px){.grid-2{grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr)}}
    .muted{color:var(--muted)} .feedback{margin-top:12px;min-height:24px;font-weight:600;padding:10px 14px;border-radius:12px;transition:opacity .3s,transform .3s;background:rgba(11,107,58,.08);color:#0b6b3a;border:1px solid rgba(11,107,58,.2);opacity:0;transform:translateY(-6px);display:flex;align-items:center;gap:8px}
    .feedback.visible{opacity:1;transform:translateY(0)}
    .feedback.error{background:rgba(179,38,30,.08);color:#b3261e;border-color:rgba(179,38,30,.25)}
    .qr-box{width:100%;max-width:480px;margin-top:12px;border:2px dashed rgba(235,25,70,.35);border-radius:18px;padding:12px;background:#fff}
    .scanner-shell{margin-top:14px;background:rgba(255,255,255,.92);border-radius:18px;border:1px solid rgba(235,25,70,.18);box-shadow:0 24px 50px rgba(0,0,0,.08);padding:14px 16px;display:flex;flex-direction:column;gap:12px}
    .scanner-shell.hidden{display:none}
    .scanner-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .scanner-header strong{display:block;font-size:1.05em}
    .scanner-header small{display:block;margin-top:2px;font-size:.92em;color:var(--muted)}
    .scanner-actions{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .camera-select{display:flex;flex-direction:column;gap:6px;font-size:.95em;color:var(--muted)}
    .camera-select select{padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:1em;min-width:200px}
    .camera-select.hidden{display:none}
    .icon-btn{appearance:none;border:1px solid rgba(235,25,70,.2);background:rgba(235,25,70,.12);color:var(--primary);border-radius:999px;width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:background .2s,color .2s,box-shadow .2s}
    .icon-btn:hover,.icon-btn:focus-visible{background:rgba(235,25,70,.22);color:var(--primary-dark);outline:none;box-shadow:0 8px 18px rgba(235,25,70,.18)}
    .stat{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#f1f4f9;border-radius:14px;border:1px solid var(--border);margin-bottom:10px;gap:12px}
    .progress{background:#e6ecf4;border-radius:999px;height:14px;overflow:hidden}
    .progress>div{height:100%;width:0;background:var(--primary);transition:width .4s}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{padding:10px 16px;background:#eef2f8;border-radius:999px;cursor:pointer;color:var(--secondary);font-weight:600;transition:background .2s,color .2s}
    .tab:hover{background:#e0e6f0}
    .tab.active{background:var(--primary);color:#fff;box-shadow:0 10px 20px rgba(235,25,70,.28)}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .card-item{background:#fff;border-radius:14px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .card-item h4{margin:4px 0 8px}
    .card-item small{color:var(--muted)}
    .content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .content{background:#fff;border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .nav{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(110deg,var(--primary) 0%,var(--primary-dark) 65%);display:flex;justify-content:space-around;gap:10px;padding:12px 22px calc(18px + env(safe-area-inset-bottom));box-shadow:0 -12px 28px rgba(0,0,0,.16);backdrop-filter:blur(10px);z-index:30}
    .nav-btn{flex:1;background:transparent;border:none;padding:10px 8px;border-radius:14px;color:rgba(255,255,255,.8);font-weight:600;transition:background .2s,color .2s;display:flex;flex-direction:column;align-items:center;gap:6px;font-size:.95rem;letter-spacing:.01em}
    .nav-btn.active,.nav-btn:focus-visible{background:rgba(255,255,255,.22);color:#fff;outline:2px solid transparent;box-shadow:0 12px 24px rgba(0,0,0,.18)}
    .nav-icon{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px}
    .nav-icon svg{width:100%;height:100%;stroke:currentColor;stroke-width:1.8;fill:none;stroke-linecap:round;stroke-linejoin:round}
    .nav-icon svg *{fill:none}
    .nav-label{line-height:1}
    .counter{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .manual-entry{display:flex;gap:10px;align-items:flex-end;width:100%}
    .manual-entry label{flex:1}
    .manual-hint{display:block;margin-top:6px;color:var(--muted);font-size:.92em}
    .challenge{margin-top:10px}
    @media(max-width:720px){
      body{font-size:clamp(16px,4.4vw,20px)}
      .app-header{padding:12px 16px;gap:12px}
      .logo img{height:44px}
      .title h1{font-size:1.25em}
      .title small{font-size:.95em}
      main.container{padding:20px 16px calc(120px + env(safe-area-inset-bottom));gap:20px}
      .card{padding:20px}
      .card h2{font-size:1.55em}
      .card h3{font-size:1.3em}
      label{font-size:1em}
      .form-grid{grid-template-columns:1fr;gap:12px}
      input{font-size:1.05em}
      .btn{width:100%;font-size:1.08em;padding:14px 20px}
      .grid-2{gap:20px}
      .counter{flex-direction:column;align-items:stretch}
      .counter label{flex:1}
      .manual-entry{flex-direction:column;align-items:stretch}
      .manual-entry .btn{margin-top:8px}
      .list,.content-grid{grid-template-columns:1fr}
      .stat{flex-direction:column;align-items:flex-start;gap:6px;font-size:1.05em}
      .qr-box{max-width:100%;margin-left:auto;margin-right:auto;padding:16px}
      .nav{gap:8px;padding:12px 18px calc(20px + env(safe-area-inset-bottom))}
      .nav-btn{font-size:1.05em;padding:12px 6px}
      .nav-icon{width:28px;height:28px}
      .scanner-shell{padding:16px}
      .scanner-actions{flex-direction:column;align-items:stretch}
      .camera-select select{width:100%}
      .icon-btn{background:rgba(235,25,70,.12);color:var(--primary)}
    }
  </style>

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <header class="app-header">
    <div class="logo"><img src="https://tepeyacxcaret.mx/wp-content/uploads/2024/11/cropped-logo-nuevo-it-xcaret-blanco-01.png" alt="Instituto Tepeyac Xcaret"></div>
    <div class="title">
      <h1 id="schoolName"></h1>
      <small>Proyecto de Reciclaje – 5º</small>
    </div>
  </header>

  <main class="container">
    <section id="view-register" class="card">
      <h2>¡Hola! Crea tu perfil</h2>
      <p class="muted">La primera vez, dinos quién eres. Guardaremos tus datos en este dispositivo.</p>
      <div class="form-grid">
        <label>ID Alumno <input id="reg-id" placeholder="Ej: A-0501" required></label>
        <label>Nombre <input id="reg-name" placeholder="Ej: Sofía L." required></label>
        <label>Grupo <input id="reg-group" placeholder="Ej: 5°" required></label>
        <label>Clase <input id="reg-class" placeholder="Ej: 5A" required></label>
        <label>Email (opcional) <input id="reg-email" type="email" placeholder="tucorreo@colegio.edu"></label>
      </div>
      <button class="btn primary" id="btn-save-profile">Guardar</button>
    </section>

    <section id="view-home" class="card hidden">
      <h2>¡Bienvenido, <span id="studentName"></span>!</h2>
      <div class="grid-2">
        <div class="card soft">
          <h3>Escanear y Registrar</h3>
          <p>Deposita plástico en el contenedor correcto y escanea el QR.</p>
          <button class="btn primary" id="btn-open-scanner">Abrir cámara</button>
          <div id="scanner-shell" class="scanner-shell hidden">
            <div class="scanner-header">
              <div>
                <strong>Escáner activo</strong>
                <small id="scanner-status">Apunta al QR del contenedor para registrar tu depósito.</small>
              </div>
              <button class="icon-btn" id="btn-close-scanner" aria-label="Cerrar escáner">&times;</button>
            </div>
            <div id="qr-reader" class="qr-box"></div>
            <div class="scanner-actions">
              <label id="camera-select-wrapper" class="camera-select hidden">
                Cámara
                <select id="camera-select"></select>
              </label>
              <button class="btn outline" id="btn-refresh-camera" type="button">Reintentar cámara</button>
            </div>
          </div>
          <div class="counter">
            <label>Cantidad <input id="deposit-count" type="number" min="1" value="1"></label>
            <div class="manual-entry">
              <label>ID contenedor <input id="manual-container-id" placeholder="Ej: CT-101"></label>
              <button class="btn" id="btn-log-manual">Registrar sin QR</button>
            </div>
          </div>
          <small class="manual-hint">¿No puedes escanear el código? Pídele a un docente que escriba el ID del contenedor aquí.</small>
          <div id="feedback" class="feedback" role="status" aria-live="polite"></div>
        </div>
        <div class="card soft">
          <h3>Mi Progreso</h3>
          <div class="stat"><div>Puntos</div><strong id="myPoints">0</strong></div>
          <div class="stat"><div>Depósitos</div><strong id="myDeposits">0</strong></div>
          <div id="challengeBox" class="challenge hidden">
            <h4>Reto semanal</h4>
            <div class="progress"><div id="ch-progress"></div></div>
            <small id="ch-text"></small>
          </div>
          <button class="btn" id="btn-edit-profile">Editar perfil</button>
        </div>
      </div>
    </section>

    <section id="view-challenges" class="card hidden">
      <h2>Retos</h2>
      <div id="challenge-info" class="card soft"></div>
    </section>

    <section id="view-ranking" class="card hidden">
      <h2>Rankings</h2>
      <div class="tabs">
        <button class="tab active" data-tab="student">Estudiantes</button>
        <button class="tab" data-tab="class">Clases</button>
        <button class="tab" data-tab="group">Grupos</button>
      </div>
      <div id="rank-student"></div>
      <div id="rank-class" class="hidden"></div>
      <div id="rank-group" class="hidden"></div>
    </section>

    <section id="view-rewards" class="card hidden">
      <h2>Tienda Verde</h2>
      <div id="rewards-list" class="list"></div>
    </section>

    <section id="view-learn" class="card hidden">
      <h2>Aprende y Actúa</h2>
      <div class="content-grid" id="content-list"></div>
    </section>

    <section id="view-admin" class="card hidden">
      <h2>Panel Docente</h2>
      <div class="form-row">
        <label>Clave docente <input id="admin-key" type="password" placeholder="••••"></label>
        <button class="btn" id="btn-admin-login">Entrar</button>
      </div>
      <div id="admin-area" class="hidden">
        <div class="grid-2">
          <div class="card soft">
            <h3>Estadísticas</h3>
            <div id="kpi-total"></div>
            <div id="chart-by-mat" style="height:280px"></div>
            <h4>Top estudiantes</h4>
            <div id="top-students"></div>
            <h4>Top clases</h4>
            <div id="top-classes"></div>
          </div>
          <div class="card soft">
            <h3>Acciones</h3>
            <button class="btn" id="btn-export">Exportar CSV</button>
            <button class="btn" id="btn-roll-challenge">Nueva semana (reto)</button>
            <small class="muted">Usa esto al iniciar la semana escolar.</small>
          </div>
        </div>
      </div>
    </section>

    <nav class="nav">
      <button class="nav-btn" data-go="view-home">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M3 10.5 12 4l9 6.5" />
            <path d="M5.25 9.75V19.5A1.5 1.5 0 0 0 6.75 21h10.5a1.5 1.5 0 0 0 1.5-1.5V9.75" />
            <path d="M9.25 21v-6.5h5.5V21" />
          </svg>
        </span>
        <span class="nav-label">Inicio</span>
      </button>
      <button class="nav-btn" data-go="view-challenges">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M5 21V3" />
            <path d="M5 4.5h9.25a1 1 0 0 1 .94 1.36L14 9l1.19 3.14a1 1 0 0 1-.94 1.36H5" />
          </svg>
        </span>
        <span class="nav-label">Retos</span>
      </button>
      <button class="nav-btn" data-go="view-ranking">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M4 21h16" />
            <path d="M7 21v-7.5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1V21" />
            <path d="M11 21V5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v16" />
            <path d="M15 21v-10a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1V21" />
          </svg>
        </span>
        <span class="nav-label">Ranking</span>
      </button>
      <button class="nav-btn" data-go="view-rewards">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <rect x="4" y="9" width="16" height="11" rx="1.6" />
            <path d="M4 9h16" />
            <path d="M12 20V5.25" />
            <path d="M7.5 6.5a2.5 2.5 0 1 1 4.5-1.5" />
            <path d="M16.5 6.5a2.5 2.5 0 1 0-4.5-1.5" />
          </svg>
        </span>
        <span class="nav-label">Recompensas</span>
      </button>
      <button class="nav-btn" data-go="view-learn">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M12 4 3 8l9 4 9-4-9-4z" />
            <path d="M5 9v5l7 3 7-3V9" />
            <path d="M19 10v6.5" />
          </svg>
        </span>
        <span class="nav-label">Aprende</span>
      </button>
      <button class="nav-btn" data-go="view-admin">
        <span class="nav-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M12 4.5 20 7v6c0 4.9-3.5 9.2-8 9.75C7.5 22.2 4 17.9 4 13V7l8-2.5z" />
            <path d="M9.75 12.5a2.25 2.25 0 1 1 4.5 0" />
            <path d="M8 17c1.1-1.2 2.5-1.8 4-1.8s2.9.6 4 1.8" />
          </svg>
        </span>
        <span class="nav-label">Docentes</span>
      </button>
    </nav>
  </main>

  <script>
    function $(s){ return document.querySelector(s); }
    function $$(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }

    var html5Scanner = null;
    var profile = null;
    var cameraDevices = [];
    var selectedCameraId = null;
    var SCANNER_STORAGE_KEY = 'recycle_camera_preference';
    var scannerShell = document.getElementById('scanner-shell');
    var cameraSelect = document.getElementById('camera-select');
    var cameraSelectWrapper = document.getElementById('camera-select-wrapper');
    var scannerStatus = document.getElementById('scanner-status');
    var closeScannerButton = document.getElementById('btn-close-scanner');
    var refreshCameraButton = document.getElementById('btn-refresh-camera');
    var feedbackBox = document.getElementById('feedback');
    var feedbackTimer = null;

    function show(id){
      ['view-register','view-home','view-challenges','view-ranking','view-rewards','view-learn','view-admin']
        .forEach(function(v){ document.getElementById(v).classList.toggle('hidden', v !== id); });
      if (id !== 'view-home') closeScanner();
      setActiveNav(id);
    }

    function setActiveNav(id){
      $$('.nav-btn').forEach(function(btn){
        btn.classList.toggle('active', btn.dataset.go === id);
      });
    }

    $$('.nav-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        var id = btn.dataset.go;
        if (id === 'view-home' && !profile) return show('view-register');
        show(id);
        if (id === 'view-challenges') loadChallenges();
        if (id === 'view-ranking') loadRanking();
        if (id === 'view-rewards') loadRewards();
        if (id === 'view-learn') loadContent();
      });
    });

    function loadProfileFromLocal() {
      try { profile = JSON.parse(localStorage.getItem('recycle_profile') || 'null'); } catch(e){ profile = null; }
    }
    function saveProfileLocal(p) { localStorage.setItem('recycle_profile', JSON.stringify(p)); }
    function finishProfileSetup(p, notice){
      profile = p;
      saveProfileLocal(profile);
      hydrateHome();
      show('view-home');
      if (notice) {
        setTimeout(function(){ alert(notice); }, 60);
      }
    }

    $('#btn-save-profile').addEventListener('click', function(){
      var p = {
        studentId: $('#reg-id').value.trim(),
        name: $('#reg-name').value.trim(),
        group: $('#reg-group').value.trim(),
        className: $('#reg-class').value.trim(),
        email: $('#reg-email').value.trim()
      };
      if (!p.studentId || !p.name || !p.group || !p.className) {
        alert('Completa ID, Nombre, Grupo y Clase');
        return;
      }
      google.script.run
        .withSuccessHandler(function(st){
          if (!st || st.ok === false) {
            console.warn('Fallo al sincronizar perfil, usando almacenamiento local.', st);
            finishProfileSetup(p, 'No pudimos sincronizar con la nube, pero tu perfil quedó guardado en este dispositivo.');
            return;
          }
          finishProfileSetup(p);
        })
        .withFailureHandler(function(err){
          console.warn('Error guardando perfil, se continúa en modo local.', err);
          finishProfileSetup(p, 'No pudimos conectar con el servidor, pero tu perfil quedó guardado en este dispositivo.');
        })
        .upsertStudent(p);
    });

    $('#btn-edit-profile').addEventListener('click', function(){
      $('#reg-id').value = profile.studentId;
      $('#reg-name').value = profile.name;
      $('#reg-group').value = profile.group;
      $('#reg-class').value = profile.className;
      $('#reg-email').value = profile.email || '';
      show('view-register');
    });

    function hydrateHome(){
      $('#studentName').textContent = (profile && profile.name) ? profile.name : 'Estudiante';
      google.script.run.withSuccessHandler(function(res){
        if (!res || !res.ok) return;
        $('#myPoints').textContent = res.points;
        $('#myDeposits').textContent = res.deposits;
        if (res.challenge) {
          var goal = res.challenge.goal, done = res.challenge.done, start = res.challenge.start, end = res.challenge.end, bonus = res.challenge.bonus;
          var pct = Math.min(100, Math.round((done/goal)*100));
          $('#ch-progress').style.width = pct + '%';
          $('#ch-text').textContent = 'Lleva ' + done + '/' + goal + '. Semana ' + start + ' a ' + end + '. Bono +' + bonus + ' pts.';
          $('#challengeBox').classList.remove('hidden');
        } else {
          $('#challengeBox').classList.add('hidden');
        }
      }).getMySummary(profile.studentId);
    }

    function openScanner(){
      if (!profile) return show('view-register');
      if (!scannerShell) return;
      scannerShell.classList.remove('hidden');
      if (scannerStatus) scannerStatus.textContent = 'Preparando cámara...';
      loadAndStartCamera();
    }

    $('#btn-open-scanner').addEventListener('click', openScanner);
    if (closeScannerButton) closeScannerButton.addEventListener('click', function(){ closeScanner(); });
    if (cameraSelect) {
      cameraSelect.addEventListener('change', function(){ startCamera(cameraSelect.value || null); });
    }
    if (refreshCameraButton) {
      refreshCameraButton.addEventListener('click', function(){
        localStorage.removeItem(SCANNER_STORAGE_KEY);
        selectedCameraId = null;
        loadAndStartCamera();
      });
    }

    function onScanSuccess(decodedText){
      var count = Number($('#deposit-count').value || 1);
      registerDeposit(decodedText, count);
      closeScanner();
    }
    $('#btn-log-manual').addEventListener('click', function(){
      var count = Number($('#deposit-count').value || 1);
      var containerInput = document.getElementById('manual-container-id');
      var manualId = containerInput ? containerInput.value.trim().toUpperCase() : '';
      if (!manualId) {
        feedback('Ingresa el ID del contenedor que te compartió el docente.', true);
        return;
      }
      var manualQR = 'RCP|PLASTICO|' + manualId + '|MANUAL';
      registerDeposit(manualQR, count);
    });

    function feedback(msg, isError){
      if (!feedbackBox) return;
      if (feedbackTimer) clearTimeout(feedbackTimer);
      feedbackBox.textContent = msg || '';
      feedbackBox.classList.toggle('error', !!isError && !!msg);
      if (msg) {
        if (!isError) feedbackBox.textContent = msg + ' ✅';
        feedbackBox.classList.add('visible');
        feedbackTimer = setTimeout(function(){
          feedbackBox.classList.remove('visible', 'error');
          feedbackBox.textContent = '';
        }, isError ? 6000 : 3500);
      } else {
        feedbackBox.classList.remove('visible', 'error');
      }
    }

    function closeScanner(){
      if (scannerShell) scannerShell.classList.add('hidden');
      if (cameraSelect) cameraSelect.disabled = false;
      stopScanner();
    }

    function stopScanner(){
      if (!html5Scanner) return Promise.resolve();
      var instance = html5Scanner;
      html5Scanner = null;
      return instance.stop().then(function(){
        try { instance.clear(); } catch(e) {}
      }).catch(function(err){
        console.warn('No se pudo detener la cámara', err);
      });
    }

    function loadAndStartCamera(){
      if (typeof Html5Qrcode === 'undefined') {
        feedback('La biblioteca de escaneo no está disponible.', true);
        return;
      }
      Html5Qrcode.getCameras().then(function(devices){
        cameraDevices = devices || [];
        if (!cameraDevices.length) {
          if (scannerStatus) scannerStatus.textContent = 'No encontramos una cámara disponible.';
          feedback('No encontramos una cámara disponible. Usa "Registrar sin QR".', true);
          if (cameraSelectWrapper) cameraSelectWrapper.classList.add('hidden');
          return stopScanner();
        }
        var stored = localStorage.getItem(SCANNER_STORAGE_KEY);
        var bestCam = determineBestCamera(cameraDevices, stored);
        populateCameraSelect(cameraDevices, bestCam);
        startCamera(bestCam);
      }).catch(function(err){
        console.warn('Error obteniendo cámaras', err);
        if (scannerStatus) scannerStatus.textContent = 'No pudimos acceder a la cámara.';
        feedback('No pudimos acceder a la cámara. Usa "Registrar sin QR".', true);
      });
    }

    function determineBestCamera(devices, stored){
      if (stored && devices.some(function(d){ return d.id === stored; })) return stored;
      var backCam = devices.find(function(d){ return /back|rear|environment/i.test(d.label || ''); });
      if (backCam) return backCam.id;
      return devices[0] ? devices[0].id : null;
    }

    function populateCameraSelect(devices, selected){
      if (!cameraSelect) return;
      cameraSelect.innerHTML = '';
      if (!devices || !devices.length) {
        if (cameraSelectWrapper) cameraSelectWrapper.classList.add('hidden');
        return;
      }
      var autoOption = document.createElement('option');
      autoOption.value = '';
      autoOption.textContent = devices.length > 1 ? 'Automática (recomendada)' : (devices[0].label || 'Cámara');
      cameraSelect.appendChild(autoOption);
      devices.forEach(function(device, index){
        var option = document.createElement('option');
        option.value = device.id;
        option.textContent = device.label || ('Cámara ' + (index + 1));
        cameraSelect.appendChild(option);
      });
      if (cameraSelectWrapper) {
        if (devices.length > 1) {
          cameraSelectWrapper.classList.remove('hidden');
        } else {
          cameraSelectWrapper.classList.add('hidden');
        }
      }
      if (selected && devices.some(function(d){ return d.id === selected; })) {
        cameraSelect.value = selected;
      } else {
        cameraSelect.value = '';
      }
    }

    function startCamera(cameraId){
      if (cameraSelect) cameraSelect.disabled = true;
      selectedCameraId = cameraId || null;
      if (selectedCameraId) {
        localStorage.setItem(SCANNER_STORAGE_KEY, selectedCameraId);
      } else {
        localStorage.removeItem(SCANNER_STORAGE_KEY);
      }
      if (scannerStatus) scannerStatus.textContent = 'Activando cámara...';
      var startParam = selectedCameraId ? selectedCameraId : { facingMode: 'environment' };
      stopScanner().then(function(){
        if (scannerShell && scannerShell.classList.contains('hidden')) {
          if (cameraSelect) cameraSelect.disabled = false;
          return;
        }
        html5Scanner = new Html5Qrcode('qr-reader');
        var boxSize = Math.min(360, Math.round(window.innerWidth * 0.75));
        var config = { fps: 12, qrbox: { width: boxSize, height: boxSize }, aspectRatio: window.innerWidth < 720 ? 1.4 : 1.0 };
        html5Scanner.start(startParam, config, onScanSuccess, function(){
          if (scannerStatus) scannerStatus.textContent = 'Intentando leer el QR...';
        }).then(function(){
          if (scannerStatus) scannerStatus.textContent = 'Escanea el QR del contenedor.';
          if (cameraSelect) cameraSelect.disabled = false;
        }).catch(function(err){
          console.warn('No se pudo iniciar la cámara', err);
          if (cameraSelect) cameraSelect.disabled = false;
          if (scannerStatus) scannerStatus.textContent = 'No se pudo iniciar la cámara.';
          feedback('No se pudo iniciar la cámara. Usa "Registrar sin QR".', true);
        });
      });
    }

    function registerDeposit(qrText, count){
      if (!profile) return show('view-register');
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) {
            var errMsg = res && res.error ? res.error : 'Error al registrar';
            if (/contenedor no registrado/i.test(errMsg)) {
              errMsg = 'Contenedor no registrado. Verifica el ID con un docente.';
            }
            return feedback(errMsg, true);
          }
          feedback('Registrado: +' + res.pointsAwarded + ' pts');
          var manualBox = document.getElementById('manual-container-id');
          if (manualBox) manualBox.value = '';
          hydrateHome();
        })
        .withFailureHandler(function(err){
          var msg = (err && err.message) ? err.message : JSON.stringify(err);
          feedback('Error: ' + msg, true);
        })
        .logRecycling({ qrText: qrText, studentId: profile.studentId, count: count });
    }

    function loadChallenges(){
      var box = document.getElementById('challenge-info');
      box.innerHTML = '<p class="muted">Cargando...</p>';
      google.script.run.withSuccessHandler(function(res){
        if (!res || !res.ok) {
          box.innerHTML = '<p class="muted">No hay retos activos por ahora.</p>';
          return;
        }
        var ch = res.challenge;
        var status = '' +
          '<h3>' + ch.title + '</h3>' +
          '<p><strong>Objetivo:</strong> ' + ch.goal + ' depósitos entre el ' + ch.start + ' y el ' + ch.end + '.</p>' +
          '<p><strong>Bono:</strong> +' + ch.bonus + ' pts por completar el reto.</p>' +
          (ch.description ? '<p>' + ch.description + '</p>' : '') +
          '<small class="muted">Última actualización: ' + ch.updatedAt + '</small>';
        box.innerHTML = status;
      }).getActiveChallenge();
    }

    function loadRanking(){
      google.script.run.withSuccessHandler(function(list){ renderRank('#rank-student', list, 'Estudiante'); }).getLeaderboard('student');
      google.script.run.withSuccessHandler(function(list){ renderRank('#rank-class', list, 'Clase'); }).getLeaderboard('class');
      google.script.run.withSuccessHandler(function(list){ renderRank('#rank-group', list, 'Grupo'); }).getLeaderboard('group');

      $$('.tab').forEach(function(t){
        if (t.dataset.bound === '1') return;
        t.dataset.bound = '1';
        t.addEventListener('click', function(){
          $$('.tab').forEach(function(x){ x.classList.remove('active'); });
          t.classList.add('active');
          $('#rank-student').classList.add('hidden');
          $('#rank-class').classList.add('hidden');
          $('#rank-group').classList.add('hidden');
          document.getElementById('rank-'+t.dataset.tab).classList.remove('hidden');
        });
      });
    }
    function renderRank(sel, list, label){
      var el = document.querySelector(sel);
      if (!list || !list.length) { el.innerHTML = '<p class="muted">Sin datos todavía.</p>'; return; }
      var rows = list.map(function(r,i){
        var left = label==='Estudiante'
          ? (i+1) + '. ' + r.name + ' <small class="muted">(' + (r.class || r.group || r.id) + ')</small>'
          : (label==='Clase' ? (i+1) + '. ' + r.class : (i+1) + '. ' + r.group);
        return '<div class="stat"><div>' + left + '</div><strong>' + r.points + ' pts</strong></div>';
      }).join('');
      el.innerHTML = rows;
    }

    function loadRewards(){
      google.script.run.withSuccessHandler(function(list){
        if (!list.length) { $('#rewards-list').innerHTML = '<p class="muted">Sin recompensas activas.</p>'; return; }
        $('#rewards-list').innerHTML = list.map(function(r){
          return '' +
          '<div class="card-item">' +
            '<h4>' + r.Name + '</h4>' +
            '<small>' + (r.Description || '') + '</small>' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">' +
              '<span><strong>' + r.CostPoints + '</strong> pts</span>' +
              '<button class="btn" data-rid="' + r.RewardID + '">Canjear</button>' +
            '</div>' +
          '</div>';
        }).join('');
        $$('#rewards-list .btn').forEach(function(b){
          b.addEventListener('click', function(){
            if (!profile) return show('view-register');
            var rid = b.dataset.rid;
            var who = 'Docente';
            google.script.run
              .withSuccessHandler(function(res){
                if (!res || !res.ok) return alert(res && res.error ? res.error : 'No se pudo canjear');
                alert('Listo. Nuevo saldo: ' + res.newBalance + ' pts');
                hydrateHome();
              })
              .withFailureHandler(function(err){ alert('Error en canje: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
              .redeemReward(profile.studentId, rid, who);
          });
        });
      }).listRewards();
    }

    function loadContent(){
      google.script.run.withSuccessHandler(function(list){
        if (!list.length) { $('#content-list').innerHTML = '<p class="muted">Pronto agregaremos consejos.</p>'; return; }
        $('#content-list').innerHTML = list.map(function(c){
          return '' +
          '<div class="content">' +
            '<strong>' + (c.Category === 'tip' ? 'Consejo' : 'Dato') + ':</strong>' +
            '<h4 style="margin:.25rem 0 .5rem">' + c.Title + '</h4>' +
            '<p>' + (c.Body || '') + '</p>' +
          '</div>';
        }).join('');
      }).getContent('all');
    }

    $('#btn-admin-login').addEventListener('click', function(){
      var key = $('#admin-key').value.trim();
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) return alert(res && res.error ? res.error : 'No autorizado');
          $('#admin-area').classList.remove('hidden');
          renderAdmin(res);
        })
        .withFailureHandler(function(err){ alert('Error de panel: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
        .getDashboardStats(key);
    });
    function renderAdmin(stats){
      $('#kpi-total').innerHTML = '<div class="stat"><div>Depósitos registrados</div><strong>' + stats.totalDeposits + '</strong></div>';
      if (window.google && google.charts) {
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(function(){
          var data = new google.visualization.DataTable();
          data.addColumn('string','Material');
          data.addColumn('number','Cantidad');
          var keys = Object.keys(stats.byMaterial || {});
          if (keys.length === 0) data.addRows([['PLASTICO', 0]]);
          else {
            var rows = keys.map(function(k){ return [k, Number(stats.byMaterial[k] || 0)]; });
            data.addRows(rows);
          }
          var chart = new google.visualization.PieChart(document.getElementById('chart-by-mat'));
          chart.draw(data, {pieHole:0.5, legend:{position:'bottom'}});
        });
      }
      $('#top-students').innerHTML = stats.topStudents.map(function(r,i){
        return '<div class="stat"><div>'+(i+1)+'. '+r.name+'</div><strong>'+r.points+' pts</strong></div>';
      }).join('');
      $('#top-classes').innerHTML = stats.topClasses.map(function(r,i){
        return '<div class="stat"><div>'+(i+1)+'. '+r.class+'</div><strong>'+r.points+' pts</strong></div>';
      }).join('');
    }
    $('#btn-export').addEventListener('click', function(){
      var key = $('#admin-key').value.trim();
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) return alert(res && res.error ? res.error : 'No se pudo exportar');
          alert('CSV creado. Ábrelo desde Drive:\n' + res.url);
        })
        .withFailureHandler(function(err){ alert('Error exportando CSV: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
        .exportCSV(key);
    });
    $('#btn-roll-challenge').addEventListener('click', function(){
      var ok = confirm('Esto cerrará el reto activo y creará el de la semana actual. ¿Continuar?');
      if (!ok) return;
      google.script.run
        .withSuccessHandler(function(){ alert('Reto semanal creado/actualizado.'); })
        .withFailureHandler(function(err){ alert('Error creando reto: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
        .rollWeeklyChallenge();
    });

    (function(){
      var s = <?!= JSON.stringify(initial.settings) ?>;
      document.getElementById('schoolName').textContent = s.SCHOOL_NAME || 'Recicla App';
      document.documentElement.style.setProperty('--primary', s.PRIMARY_COLOR || '#eb1946');
      document.documentElement.style.setProperty('--secondary', s.SECONDARY_COLOR || '#00293f');
    })();

    window.addEventListener('load', function(){
      loadProfileFromLocal();
      if (profile) { hydrateHome(); show('view-home'); }
      else { show('view-register'); }
    });
    
  </script>
</body>
</html>
