<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title><?= initial.settings.SCHOOL_NAME || 'Recicla App' ?></title>

  <style>
    :root{
      --primary:#eb1946;
      --primary-dark:#c2173a;
      --secondary:#00293f;
      --accent:#f9dce3;
      --bg:#f6f8fb;
      --surface:#ffffff;
      --surface-soft:#fdf2f5;
      --text:#17212b;
      --muted:#516073;
      --border:#e1e7ef;
      --radius:16px;
      --shadow:0 16px 40px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.5;color:var(--text);background:linear-gradient(180deg,#ffffff 0%,#f6f8fb 65%);-webkit-font-smoothing:antialiased;font-size:clamp(15px,1.6vw,18px)}
    .app-header{display:flex;gap:16px;align-items:center;padding:14px 20px;background:linear-gradient(110deg,var(--primary) 0%,var(--primary-dark) 70%);box-shadow:var(--shadow);position:sticky;top:0;z-index:20;color:#fff}
    .logo{display:flex;align-items:center}
    .logo img{height:52px;width:auto}
    .title h1{font-size:1.1rem;margin:0;color:#fff}
    .title small{display:block;margin-top:4px;font-size:.85rem;color:rgba(255,255,255,.82)}
    main.container{padding:24px 20px calc(110px + env(safe-area-inset-bottom));max-width:1040px;margin:0 auto;display:grid;gap:24px}
    .card{background:var(--surface);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow);border:1px solid var(--border);display:flex;flex-direction:column;gap:16px}
    .card.soft{background:var(--surface-soft);border-color:rgba(235,25,70,.25)}
    .card h2{margin:0;font-size:1.45em;line-height:1.25}
    .card h3{margin:0;font-size:1.25em;line-height:1.3}
    .hidden{display:none}.btn{appearance:none;border:none;border-radius:14px;padding:12px 18px;background:var(--accent);color:var(--primary);cursor:pointer;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:transform .2s,box-shadow .2s,background .2s,color .2s}
    .btn.primary{background:var(--primary);color:#fff}
    .btn:hover{box-shadow:0 10px 26px rgba(235,25,70,.2);transform:translateY(-1px)}
    .btn:active{transform:translateY(0);box-shadow:none}
    .btn:focus-visible{outline:3px solid rgba(235,25,70,.35);outline-offset:2px}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:8px 0 8px}
    .form-row{display:flex;gap:10px;align-items:flex-end;margin-bottom:12px}
    label{font-size:14px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
    input{padding:12px 14px;border:1px solid var(--border);border-radius:12px;outline:0;font-size:1rem;background:#fff;transition:border .2s,box-shadow .2s}
    input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(235,25,70,.16)}
    .grid-2{display:grid;grid-template-columns:1fr;gap:20px}
    @media(min-width:960px){.grid-2{grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr)}}
    .muted{color:var(--muted)} .feedback{margin-top:8px;min-height:24px;font-weight:600}
    .qr-box{width:100%;max-width:420px;margin-top:12px;border:2px dashed rgba(235,25,70,.35);border-radius:14px;padding:12px;background:#fff}
    .stat{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#f1f4f9;border-radius:14px;border:1px solid var(--border);margin-bottom:10px;gap:12px}
    .progress{background:#e6ecf4;border-radius:999px;height:14px;overflow:hidden}
    .progress>div{height:100%;width:0;background:var(--primary);transition:width .4s}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{padding:10px 16px;background:#eef2f8;border-radius:999px;cursor:pointer;color:var(--secondary);font-weight:600;transition:background .2s,color .2s}
    .tab:hover{background:#e0e6f0}
    .tab.active{background:var(--primary);color:#fff;box-shadow:0 10px 20px rgba(235,25,70,.28)}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .card-item{background:#fff;border-radius:14px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .card-item h4{margin:4px 0 8px}
    .card-item small{color:var(--muted)}
    .content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .content{background:#fff;border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .nav{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(110deg,var(--primary) 0%,var(--primary-dark) 65%);display:flex;justify-content:space-around;gap:10px;padding:12px 22px calc(18px + env(safe-area-inset-bottom));box-shadow:0 -12px 28px rgba(0,0,0,.16);backdrop-filter:blur(10px);z-index:30}
    .nav-btn{flex:1;background:transparent;border:none;padding:12px 8px;font-size:1rem;border-radius:14px;color:rgba(255,255,255,.8);font-weight:600;transition:background .2s,color .2s}
    .nav-btn.active,.nav-btn:focus-visible{background:rgba(255,255,255,.16);color:#fff;outline:2px solid transparent}
    .counter{display:flex;gap:10px;align-items:center;margin-top:8px} .challenge{margin-top:10px}
    @media(max-width:720px){
      body{font-size:clamp(16px,4.4vw,20px)}
      .app-header{padding:12px 16px;gap:12px}
      .logo img{height:44px}
      .title h1{font-size:1.25em}
      .title small{font-size:.95em}
      main.container{padding:20px 16px calc(120px + env(safe-area-inset-bottom));gap:20px}
      .card{padding:20px}
      .card h2{font-size:1.55em}
      .card h3{font-size:1.3em}
      label{font-size:1em}
      .form-grid{grid-template-columns:1fr;gap:12px}
      input{font-size:1.05em}
      .btn{width:100%;font-size:1.08em;padding:14px 20px}
      .grid-2{gap:20px}
      .counter{flex-direction:column;align-items:stretch}
      .counter label{flex:1}
      .counter .btn{margin-top:8px}
      .list,.content-grid{grid-template-columns:1fr}
      .stat{flex-direction:column;align-items:flex-start;gap:6px;font-size:1.05em}
      .qr-box{max-width:100%;margin-left:auto;margin-right:auto;padding:16px}
      .nav{gap:8px;padding:12px 18px calc(20px + env(safe-area-inset-bottom))}
      .nav-btn{font-size:1.05em;padding:12px 6px}
    }
  </style>

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <header class="app-header">
    <div class="logo"><img src="https://tepeyacxcaret.mx/wp-content/uploads/2024/11/cropped-logo-nuevo-it-xcaret-blanco-01.png" alt="Instituto Tepeyac Xcaret"></div>
    <div class="title">
      <h1 id="schoolName"></h1>
      <small>Proyecto de Reciclaje – 5º</small>
    </div>
  </header>

  <main class="container">
    <section id="view-register" class="card">
      <h2>¡Hola! Crea tu perfil</h2>
      <p class="muted">La primera vez, dinos quién eres. Guardaremos tus datos en este dispositivo.</p>
      <div class="form-grid">
        <label>ID Alumno <input id="reg-id" placeholder="Ej: A-0501" required></label>
        <label>Nombre <input id="reg-name" placeholder="Ej: Sofía L." required></label>
        <label>Grupo <input id="reg-group" placeholder="Ej: 5°" required></label>
        <label>Clase <input id="reg-class" placeholder="Ej: 5A" required></label>
        <label>Email (opcional) <input id="reg-email" type="email" placeholder="tucorreo@colegio.edu"></label>
      </div>
      <button class="btn primary" id="btn-save-profile">Guardar</button>
    </section>

    <section id="view-home" class="card hidden">
      <h2>¡Bienvenido, <span id="studentName"></span>!</h2>
      <div class="grid-2">
        <div class="card soft">
          <h3>Escanear y Registrar</h3>
          <p>Deposita plástico en el contenedor correcto y escanea el QR.</p>
          <button class="btn primary" id="btn-open-scanner">Abrir cámara</button>
          <div id="qr-reader" class="qr-box hidden"></div>
          <div class="counter">
            <label>Cantidad <input id="deposit-count" type="number" min="1" value="1"></label>
            <button class="btn" id="btn-log-manual">Registrar sin QR</button>
          </div>
          <div id="manual-form" class="hidden" style="width:100%;display:flex;flex-direction:column;gap:10px;">
            <label>ID del contenedor
              <input id="manual-container-id" placeholder="Ej: CONT-001" autocomplete="off">
            </label>
            <small class="muted">Si el QR no aparece en la app, pídele a un profesor que valide este ID. Nosotros enviaremos la solicitud.</small>
            <button class="btn" id="btn-submit-manual">Enviar solicitud a docente</button>
          </div>
          <div id="feedback" class="feedback"></div>
        </div>
        <div class="card soft">
          <h3>Mi Progreso</h3>
          <div class="stat"><div>Puntos</div><strong id="myPoints">0</strong></div>
          <div class="stat"><div>Depósitos</div><strong id="myDeposits">0</strong></div>
          <div id="challengeBox" class="challenge hidden">
            <h4>Reto semanal</h4>
            <div class="progress"><div id="ch-progress"></div></div>
            <small id="ch-text"></small>
          </div>
          <button class="btn" id="btn-edit-profile">Editar perfil</button>
        </div>
      </div>
    </section>

    <section id="view-challenges" class="card hidden">
      <h2>Retos</h2>
      <div id="challenge-info" class="card soft"></div>
    </section>

    <section id="view-ranking" class="card hidden">
      <h2>Rankings</h2>
      <div class="tabs">
        <button class="tab active" data-tab="student">Estudiantes</button>
        <button class="tab" data-tab="class">Clases</button>
        <button class="tab" data-tab="group">Grupos</button>
      </div>
      <div id="rank-student"></div>
      <div id="rank-class" class="hidden"></div>
      <div id="rank-group" class="hidden"></div>
    </section>

    <section id="view-rewards" class="card hidden">
      <h2>Tienda Verde</h2>
      <div id="rewards-list" class="list"></div>
    </section>

    <section id="view-learn" class="card hidden">
      <h2>Aprende y Actúa</h2>
      <div class="content-grid" id="content-list"></div>
    </section>

    <section id="view-admin" class="card hidden">
      <h2>Panel Docente</h2>
      <div class="form-row">
        <label>Clave docente <input id="admin-key" type="password" placeholder="••••"></label>
        <button class="btn" id="btn-admin-login">Entrar</button>
      </div>
      <div id="admin-area" class="hidden">
        <div class="grid-2">
          <div class="card soft">
            <h3>Estadísticas</h3>
            <div id="kpi-total"></div>
            <div id="chart-by-mat" style="height:280px"></div>
            <h4>Top estudiantes</h4>
            <div id="top-students"></div>
            <h4>Top clases</h4>
            <div id="top-classes"></div>
          </div>
          <div class="card soft">
            <h3>Acciones</h3>
            <button class="btn" id="btn-export">Exportar CSV</button>
            <button class="btn" id="btn-roll-challenge">Nueva semana (reto)</button>
            <small class="muted">Usa esto al iniciar la semana escolar.</small>
          </div>
        </div>
      </div>
    </section>

    <nav class="nav">
      <button class="nav-btn" data-go="view-home">Inicio</button>
      <button class="nav-btn" data-go="view-challenges">Retos</button>
      <button class="nav-btn" data-go="view-ranking">Ranking</button>
      <button class="nav-btn" data-go="view-rewards">Recompensas</button>
      <button class="nav-btn" data-go="view-learn">Aprende</button>
      <button class="nav-btn" data-go="view-admin">Docentes</button>
    </nav>
  </main>

  <script>
    function $(s){ return document.querySelector(s); }
    function $$(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }

    var html5Scanner = null;
    var profile = null;

    function show(id){
      ['view-register','view-home','view-challenges','view-ranking','view-rewards','view-learn','view-admin']
        .forEach(function(v){ document.getElementById(v).classList.toggle('hidden', v !== id); });
    }

    $$('.nav-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        var id = btn.dataset.go;
        if (id === 'view-home' && !profile) return show('view-register');
        show(id);
        if (id === 'view-challenges') loadChallenges();
        if (id === 'view-ranking') loadRanking();
        if (id === 'view-rewards') loadRewards();
        if (id === 'view-learn') loadContent();
      });
    });

    function loadProfileFromLocal() {
      try { profile = JSON.parse(localStorage.getItem('recycle_profile') || 'null'); } catch(e){ profile = null; }
    }
    function saveProfileLocal(p) { localStorage.setItem('recycle_profile', JSON.stringify(p)); }
    function finishProfileSetup(p, notice){
      profile = p;
      saveProfileLocal(profile);
      hydrateHome();
      show('view-home');
      if (notice) {
        setTimeout(function(){ alert(notice); }, 60);
      }
    }

    $('#btn-save-profile').addEventListener('click', function(){
      var p = {
        studentId: $('#reg-id').value.trim(),
        name: $('#reg-name').value.trim(),
        group: $('#reg-group').value.trim(),
        className: $('#reg-class').value.trim(),
        email: $('#reg-email').value.trim()
      };
      if (!p.studentId || !p.name || !p.group || !p.className) {
        alert('Completa ID, Nombre, Grupo y Clase');
        return;
      }
      google.script.run
        .withSuccessHandler(function(st){
          if (!st || st.ok === false) {
            console.warn('Fallo al sincronizar perfil, usando almacenamiento local.', st);
            finishProfileSetup(p, 'No pudimos sincronizar con la nube, pero tu perfil quedó guardado en este dispositivo.');
            return;
          }
          finishProfileSetup(p);
        })
        .withFailureHandler(function(err){
          console.warn('Error guardando perfil, se continúa en modo local.', err);
          finishProfileSetup(p, 'No pudimos conectar con el servidor, pero tu perfil quedó guardado en este dispositivo.');
        })
        .upsertStudent(p);
    });

    $('#btn-edit-profile').addEventListener('click', function(){
      $('#reg-id').value = profile.studentId;
      $('#reg-name').value = profile.name;
      $('#reg-group').value = profile.group;
      $('#reg-class').value = profile.className;
      $('#reg-email').value = profile.email || '';
      show('view-register');
    });

    function hydrateHome(){
      $('#studentName').textContent = (profile && profile.name) ? profile.name : 'Estudiante';
      google.script.run.withSuccessHandler(function(res){
        if (!res || !res.ok) return;
        $('#myPoints').textContent = res.points;
        $('#myDeposits').textContent = res.deposits;
        if (res.challenge) {
          var goal = Number(res.challenge.goal || 0);
          var done = Number(res.challenge.done || 0);
          var start = res.challenge.start;
          var end = res.challenge.end;
          var bonus = Number(res.challenge.bonus || 0);
          var pct = goal > 0 ? Math.min(100, Math.round((done / goal) * 100)) : 0;
          var bar = document.getElementById('ch-progress');
          bar.style.width = pct + '%';
          bar.setAttribute('aria-valuenow', pct);
          var text = goal > 0
            ? ('Lleva ' + done + ' de ' + goal + ' depósitos. Semana ' + start + ' a ' + end + '. Bono +' + bonus + ' pts.')
            : ('Reto activo del ' + start + ' al ' + end + '. Bono +' + bonus + ' pts.');
          document.getElementById('ch-text').textContent = text;
          document.getElementById('challengeBox').classList.remove('hidden');
        } else {
          $('#challengeBox').classList.add('hidden');
        }
      }).getMySummary(profile.studentId);
    }

    $('#btn-open-scanner').addEventListener('click', function(){
      if (!profile) return show('view-register');
      var el = document.getElementById('qr-reader');
      el.classList.remove('hidden');
      if (html5Scanner) return;
      html5Scanner = new Html5Qrcode('qr-reader');
      Html5Qrcode.getCameras().then(function(devices){
        var camId = devices && devices[0] && devices[0].id;
        if (!camId) throw new Error('No hay cámara disponible');
        html5Scanner.start(
          camId,
          { fps: 10, qrbox: {width: 250, height: 250} },
          onScanSuccess,
          function(){ }
        ).catch(function(e){
          handleCameraIssue(e);
        });
      }).catch(function(e){
        handleCameraIssue(e);
      });
    });
    function onScanSuccess(decodedText){
      var count = Number($('#deposit-count').value || 1);
      registerDeposit(decodedText, count);
      html5Scanner.stop().then(function(){
        document.getElementById('qr-reader').classList.add('hidden');
        html5Scanner = null;
      });
    }
    $('#btn-log-manual').addEventListener('click', function(){
      if (!profile) return show('view-register');
      toggleManualForm();
    });
    $('#btn-submit-manual').addEventListener('click', function(){
      if (!profile) return show('view-register');
      var count = Number($('#deposit-count').value || 1);
      submitManualRequest(count);
    });

    function feedback(msg, isError){
      var box = $('#feedback');
      box.textContent = msg || '';
      box.style.color = isError ? '#b3261e' : '#0b6b3a';
    }

    function toggleManualForm(forceShow, prefill){
      var form = document.getElementById('manual-form');
      var shouldShow = typeof forceShow === 'boolean' ? forceShow : form.classList.contains('hidden');
      form.classList.toggle('hidden', !shouldShow);
      if (shouldShow) {
        if (prefill) { document.getElementById('manual-container-id').value = prefill; }
        setTimeout(function(){ document.getElementById('manual-container-id').focus(); }, 50);
      } else {
        document.getElementById('manual-container-id').value = '';
      }
    }

    function submitManualRequest(count){
      var containerId = document.getElementById('manual-container-id').value.trim();
      if (!containerId) {
        feedback('Ingresa el ID del contenedor para avisar a un docente.', true);
        return;
      }
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) {
            feedback(res && res.error ? res.error : 'No se pudo enviar la solicitud.', true);
            return;
          }
          feedback('Solicitud enviada. Un docente validará el contenedor.');
          toggleManualForm(false);
        })
        .withFailureHandler(function(err){
          var msg = (err && err.message) ? err.message : JSON.stringify(err);
          feedback('Error al enviar la solicitud: ' + msg, true);
        })
        .requestContainerValidation({
          studentId: profile.studentId,
          containerId: containerId,
          count: count
        });
    }

    function registerDeposit(qrText, count){
      if (!profile) return show('view-register');
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) {
            var errMsg = res && res.error ? res.error : 'Error al registrar';
            feedback(errMsg, true);
            if (errMsg && errMsg.indexOf('Contenedor no registrado') !== -1) {
              var containerId = parseContainerFromQR(qrText);
              toggleManualForm(true, containerId);
            }
            return;
          }
          feedback('Registrado: +' + res.pointsAwarded + ' pts');
          toggleManualForm(false);
          hydrateHome();
        })
        .withFailureHandler(function(err){
          var msg = (err && err.message) ? err.message : JSON.stringify(err);
          feedback('Error: ' + msg, true);
        })
        .logRecycling({ qrText: qrText, studentId: profile.studentId, count: count });
    }

    function parseContainerFromQR(text){
      try {
        var parts = String(text || '').split('|');
        if (parts.length >= 3) return parts[2];
      } catch(e){}
      return '';
    }

    function handleCameraIssue(err){
      console.warn('Camera warning', err);
      feedback('Si la cámara tarda en iniciar, espera unos segundos o usa el registro manual.', false);
    }

    function loadChallenges(){
      var box = document.getElementById('challenge-info');
      box.innerHTML = '<p class="muted">Cargando...</p>';
      google.script.run.withSuccessHandler(function(res){
        if (!res || !res.ok) {
          box.innerHTML = '<p class="muted">No hay retos activos por ahora.</p>';
          return;
        }
        var ch = res.challenge;
        var status = '' +
          '<h3>' + ch.title + '</h3>' +
          '<p><strong>Objetivo:</strong> ' + ch.goal + ' depósitos entre el ' + ch.start + ' y el ' + ch.end + '.</p>' +
          '<p><strong>Bono:</strong> +' + ch.bonus + ' pts por completar el reto.</p>' +
          (ch.description ? '<p>' + ch.description + '</p>' : '') +
          '<small class="muted">Última actualización: ' + ch.updatedAt + '</small>';
        box.innerHTML = status;
      }).getActiveChallenge();
    }

    function loadRanking(){
      google.script.run.withSuccessHandler(function(list){ renderRank('#rank-student', list, 'Estudiante'); }).getLeaderboard('student');
      google.script.run.withSuccessHandler(function(list){ renderRank('#rank-class', list, 'Clase'); }).getLeaderboard('class');
      google.script.run.withSuccessHandler(function(list){ renderRank('#rank-group', list, 'Grupo'); }).getLeaderboard('group');

      $$('.tab').forEach(function(t){
        t.addEventListener('click', function(){
          $$('.tab').forEach(function(x){ x.classList.remove('active'); });
          t.classList.add('active');
          $('#rank-student').classList.add('hidden');
          $('#rank-class').classList.add('hidden');
          $('#rank-group').classList.add('hidden');
          document.getElementById('rank-'+t.dataset.tab).classList.remove('hidden');
        });
      });
    }
    function renderRank(sel, list, label){
      var el = document.querySelector(sel);
      if (!list || !list.length) { el.innerHTML = '<p class="muted">Sin datos todavía.</p>'; return; }
      var rows = list.map(function(r,i){
        var left = label==='Estudiante'
          ? (i+1) + '. ' + r.name + ' <small class="muted">(' + (r.class || r.group || r.id) + ')</small>'
          : (label==='Clase' ? (i+1) + '. ' + r.class : (i+1) + '. ' + r.group);
        return '<div class="stat"><div>' + left + '</div><strong>' + r.points + ' pts</strong></div>';
      }).join('');
      el.innerHTML = rows;
    }

    function loadRewards(){
      google.script.run.withSuccessHandler(function(list){
        if (!list.length) { $('#rewards-list').innerHTML = '<p class="muted">Sin recompensas activas.</p>'; return; }
        $('#rewards-list').innerHTML = list.map(function(r){
          return '' +
          '<div class="card-item">' +
            '<h4>' + r.Name + '</h4>' +
            '<small>' + (r.Description || '') + '</small>' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">' +
              '<span><strong>' + r.CostPoints + '</strong> pts</span>' +
              '<button class="btn" data-rid="' + r.RewardID + '">Canjear</button>' +
            '</div>' +
          '</div>';
        }).join('');
        $$('#rewards-list .btn').forEach(function(b){
          b.addEventListener('click', function(){
            if (!profile) return show('view-register');
            var rid = b.dataset.rid;
            var who = 'Docente';
            google.script.run
              .withSuccessHandler(function(res){
                if (!res || !res.ok) return alert(res && res.error ? res.error : 'No se pudo canjear');
                alert('Listo. Nuevo saldo: ' + res.newBalance + ' pts');
                hydrateHome();
              })
              .withFailureHandler(function(err){ alert('Error en canje: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
              .redeemReward(profile.studentId, rid, who);
          });
        });
      }).listRewards();
    }

    function loadContent(){
      google.script.run.withSuccessHandler(function(list){
        if (!list.length) { $('#content-list').innerHTML = '<p class="muted">Pronto agregaremos consejos.</p>'; return; }
        $('#content-list').innerHTML = list.map(function(c){
          return '' +
          '<div class="content">' +
            '<strong>' + (c.Category === 'tip' ? 'Consejo' : 'Dato') + ':</strong>' +
            '<h4 style="margin:.25rem 0 .5rem">' + c.Title + '</h4>' +
            '<p>' + (c.Body || '') + '</p>' +
          '</div>';
        }).join('');
      }).getContent('all');
    }

    $('#btn-admin-login').addEventListener('click', function(){
      var key = $('#admin-key').value.trim();
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) return alert(res && res.error ? res.error : 'No autorizado');
          $('#admin-area').classList.remove('hidden');
          renderAdmin(res);
        })
        .withFailureHandler(function(err){ alert('Error de panel: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
        .getDashboardStats(key);
    });
    function renderAdmin(stats){
      $('#kpi-total').innerHTML = '<div class="stat"><div>Depósitos registrados</div><strong>' + stats.totalDeposits + '</strong></div>';
      if (window.google && google.charts) {
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(function(){
          var data = new google.visualization.DataTable();
          data.addColumn('string','Material');
          data.addColumn('number','Cantidad');
          var keys = Object.keys(stats.byMaterial || {});
          if (keys.length === 0) data.addRows([['PLASTICO', 0]]);
          else {
            var rows = keys.map(function(k){ return [k, Number(stats.byMaterial[k] || 0)]; });
            data.addRows(rows);
          }
          var chart = new google.visualization.PieChart(document.getElementById('chart-by-mat'));
          chart.draw(data, {pieHole:0.5, legend:{position:'bottom'}});
        });
      }
      $('#top-students').innerHTML = stats.topStudents.map(function(r,i){
        return '<div class="stat"><div>'+(i+1)+'. '+r.name+'</div><strong>'+r.points+' pts</strong></div>';
      }).join('');
      $('#top-classes').innerHTML = stats.topClasses.map(function(r,i){
        return '<div class="stat"><div>'+(i+1)+'. '+r.class+'</div><strong>'+r.points+' pts</strong></div>';
      }).join('');
    }
    $('#btn-export').addEventListener('click', function(){
      var key = $('#admin-key').value.trim();
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) return alert(res && res.error ? res.error : 'No se pudo exportar');
          alert('CSV creado. Ábrelo desde Drive:\n' + res.url);
        })
        .withFailureHandler(function(err){ alert('Error exportando CSV: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
        .exportCSV(key);
    });
    $('#btn-roll-challenge').addEventListener('click', function(){
      var ok = confirm('Esto cerrará el reto activo y creará el de la semana actual. ¿Continuar?');
      if (!ok) return;
      google.script.run
        .withSuccessHandler(function(){ alert('Reto semanal creado/actualizado.'); })
        .withFailureHandler(function(err){ alert('Error creando reto: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
        .rollWeeklyChallenge();
    });

    (function(){
      var s = <?!= JSON.stringify(initial.settings) ?>;
      document.getElementById('schoolName').textContent = s.SCHOOL_NAME || 'Recicla App';
      document.documentElement.style.setProperty('--primary', s.PRIMARY_COLOR || '#eb1946');
      document.documentElement.style.setProperty('--secondary', s.SECONDARY_COLOR || '#00293f');
    })();

    window.addEventListener('load', function(){
      loadProfileFromLocal();
      if (profile) { hydrateHome(); show('view-home'); }
      else { show('view-register'); }
    });
    
  </script>
</body>
</html>
