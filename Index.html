<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title><?= initial.settings.SCHOOL_NAME || 'Recicla App' ?></title>

  <style>
    :root{
      --primary:#eb1946;
      --primary-dark:#c2173a;
      --secondary:#01263b;
      --accent:#f9dce3;
      --accent-strong:#ffe3eb;
      --bg:#f4f7fb;
      --surface:#ffffff;
      --surface-soft:#fdf2f5;
      --text:#162433;
      --muted:#526173;
      --border:#dfe5ef;
      --radius:16px;
      --shadow:0 18px 45px rgba(14,34,56,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.5;color:var(--text);background:linear-gradient(180deg,#ffffff 0%,#f4f7fb 65%);-webkit-font-smoothing:antialiased;font-size:clamp(15px,1.6vw,18px);transition:background .4s ease,color .4s ease}
    body.modal-open{overflow:hidden;touch-action:none}
    .app-header{display:flex;gap:16px;align-items:center;padding:14px 20px;background:linear-gradient(110deg,var(--primary) 0%,var(--primary-dark) 70%);box-shadow:var(--shadow);position:sticky;top:0;z-index:40;color:#fff}
    .logo{display:flex;align-items:center}
    .logo img{height:52px;width:auto}
    .title h1{font-size:1.1rem;margin:0;color:#fff}
    .title small{display:block;margin-top:4px;font-size:.85rem;color:rgba(255,255,255,.82)}
    main.container{padding:28px 24px calc(120px + env(safe-area-inset-bottom));max-width:1080px;margin:0 auto;display:grid;gap:26px}
    .card{background:var(--surface);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);border:1px solid rgba(13,32,53,.04);display:flex;flex-direction:column;gap:18px;backdrop-filter:saturate(160%) blur(6px)}
    .card.soft{background:var(--surface-soft);border-color:rgba(235,25,70,.25)}
    .card h2{margin:0;font-size:1.45em;line-height:1.25}
    .card h3{margin:0;font-size:1.25em;line-height:1.3}
    .hidden{display:none}
    .btn{appearance:none;border:none;border-radius:14px;padding:12px 18px;background:var(--accent);color:var(--primary);cursor:pointer;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:transform .2s,box-shadow .2s,background .2s,color .2s}
    .btn.primary{background:var(--primary);color:#fff;box-shadow:0 14px 28px rgba(235,25,70,.25)}
    .btn.secondary{background:var(--surface);color:var(--secondary);border:1px solid rgba(1,38,59,.12)}
    .btn.icon-only{width:48px;height:48px;padding:0;border-radius:50%;background:var(--accent-strong)}
    .btn:hover{box-shadow:0 12px 28px rgba(235,25,70,.18);transform:translateY(-1px)}
    .btn:active{transform:translateY(0);box-shadow:none}
    .btn:focus-visible{outline:3px solid rgba(235,25,70,.35);outline-offset:2px}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:8px 0 8px}
    .form-row{display:flex;gap:10px;align-items:flex-end;margin-bottom:12px}
    label{font-size:14px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
    input{padding:12px 14px;border:1px solid var(--border);border-radius:12px;outline:0;font-size:1rem;background:#fff;transition:border .2s,box-shadow .2s}
    input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(235,25,70,.16)}
    .grid-2{display:grid;grid-template-columns:1fr;gap:20px}
    @media(min-width:960px){.grid-2{grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr)}}
    .muted{color:var(--muted)} .feedback{margin-top:8px;min-height:24px;font-weight:600}
    .stat{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#f1f4f9;border-radius:14px;border:1px solid var(--border);margin-bottom:10px;gap:12px}
    .progress{background:#e6ecf4;border-radius:999px;height:14px;overflow:hidden}
    .progress>div{height:100%;width:0;background:var(--primary);transition:width .4s}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{padding:10px 16px;background:#eef2f8;border-radius:999px;cursor:pointer;color:var(--secondary);font-weight:600;transition:background .2s,color .2s}
    .tab:hover{background:#e0e6f0}
    .tab.active{background:var(--primary);color:#fff;box-shadow:0 10px 20px rgba(235,25,70,.28)}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .card-item{background:#fff;border-radius:14px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .card-item h4{margin:4px 0 8px}
    .card-item small{color:var(--muted)}
    .content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .content{background:#fff;border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .nav{position:fixed;bottom:0;left:0;right:0;background:rgba(0,26,44,.92);display:flex;justify-content:space-around;gap:10px;padding:12px 22px calc(22px + env(safe-area-inset-bottom));box-shadow:0 -18px 32px rgba(3,24,42,.38);backdrop-filter:blur(14px) saturate(160%);z-index:45}
    .nav-btn{flex:1;background:transparent;border:none;padding:10px 6px;font-size:.95rem;border-radius:16px;color:rgba(255,255,255,.74);font-weight:600;display:flex;flex-direction:column;align-items:center;gap:6px;min-width:0;transition:background .2s ease,color .2s ease,transform .2s ease}
    .nav-btn .icon{font-size:1.35rem;line-height:1}
    .nav-btn .label{white-space:nowrap}
    .nav-btn.active,.nav-btn:focus-visible{background:rgba(255,255,255,.15);color:#fff;outline:2px solid transparent;transform:translateY(-2px)}
    .counter{display:flex;gap:10px;align-items:center;margin-top:8px}
    .challenge{margin-top:10px}
    .scanner-modal{position:fixed;inset:0;background:rgba(6,20,33,.62);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:24px;z-index:60;transition:opacity .25s ease,visibility .25s ease}
    .scanner-modal.hidden{opacity:0;visibility:hidden;pointer-events:none}
    .scanner-dialog{width:min(540px,100%);background:var(--surface);border-radius:22px;padding:22px;box-shadow:0 28px 60px rgba(5,22,40,.25);display:flex;flex-direction:column;gap:16px;position:relative;max-height:90vh;overflow:auto}
    .scanner-dialog header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .scanner-dialog h3{margin:0;font-size:1.35rem}
    .scanner-dialog p{margin:0;color:var(--muted)}
    .scanner-controls{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .scanner-controls label{flex:1}
    .scanner-controls select{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:1rem;appearance:none}
    .scanner-controls button{align-self:center}
    .qr-view{width:100%;min-height:260px;border-radius:18px;background:#0f1a2c;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
    .qr-view video{width:100%!important;height:100%!important;object-fit:cover;border-radius:18px}
    .qr-overlay{position:absolute;inset:10%;border:2px dashed rgba(255,255,255,.7);border-radius:20px;pointer-events:none}
    .scanner-status{font-size:.95rem;color:var(--muted);min-height:24px}
    .scanner-actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end}
    .toast-success{background:rgba(11,107,58,.12);color:#0b6b3a;padding:10px 14px;border-radius:12px;font-weight:600}
    @media(max-width:720px){
      body{font-size:clamp(16px,4.4vw,20px)}
      .app-header{padding:12px 16px;gap:12px}
      .logo img{height:44px}
      .title h1{font-size:1.25em}
      .title small{font-size:.95em}
      main.container{padding:20px 16px calc(130px + env(safe-area-inset-bottom));gap:20px}
      .card{padding:20px}
      .card h2{font-size:1.55em}
      .card h3{font-size:1.3em}
      label{font-size:1em}
      .form-grid{grid-template-columns:1fr;gap:12px}
      input,select{font-size:1.05em}
      .btn{width:100%;font-size:1.05em;padding:14px 20px}
      .btn.icon-only{width:46px;height:46px}
      .grid-2{gap:20px}
      .counter{flex-direction:column;align-items:stretch}
      .counter label{flex:1}
      .counter .btn{margin-top:8px}
      .list,.content-grid{grid-template-columns:1fr}
      .stat{flex-direction:column;align-items:flex-start;gap:6px;font-size:1.05em}
      .nav{gap:8px;padding:12px 18px calc(24px + env(safe-area-inset-bottom))}
      .nav-btn{font-size:1.02em;padding:10px 4px}
      .nav-btn .icon{font-size:1.3rem}
      .scanner-dialog{padding:18px}
    }
  </style>

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <header class="app-header">
    <div class="logo"><img src="https://tepeyacxcaret.mx/wp-content/uploads/2024/11/cropped-logo-nuevo-it-xcaret-blanco-01.png" alt="Instituto Tepeyac Xcaret"></div>
    <div class="title">
      <h1 id="schoolName"></h1>
      <small>Proyecto de Reciclaje – 5º</small>
    </div>
  </header>

  <main class="container">
    <section id="view-register" class="card">
      <h2>¡Hola! Crea tu perfil</h2>
      <p class="muted">La primera vez, dinos quién eres. Guardaremos tus datos en este dispositivo.</p>
      <div class="form-grid">
        <label>ID Alumno <input id="reg-id" placeholder="Ej: A-0501" required></label>
        <label>Nombre <input id="reg-name" placeholder="Ej: Sofía L." required></label>
        <label>Grupo <input id="reg-group" placeholder="Ej: 5°" required></label>
        <label>Clase <input id="reg-class" placeholder="Ej: 5A" required></label>
        <label>Email (opcional) <input id="reg-email" type="email" placeholder="tucorreo@colegio.edu"></label>
      </div>
      <button class="btn primary" id="btn-save-profile">Guardar</button>
    </section>

    <section id="view-home" class="card hidden">
      <h2>¡Bienvenido, <span id="studentName"></span>!</h2>
      <div class="grid-2">
        <div class="card soft">
          <h3>Escanear y Registrar</h3>
          <p>Deposita plástico en el contenedor correcto y escanea el QR.</p>
          <button class="btn primary" id="btn-open-scanner">Abrir cámara</button>
          <div class="counter">
            <label>Cantidad <input id="deposit-count" type="number" min="1" value="1"></label>
            <button class="btn" id="btn-log-manual">Registrar sin QR</button>
          </div>
          <div id="feedback" class="feedback" role="status" aria-live="polite"></div>
        </div>
        <div class="card soft">
          <h3>Mi Progreso</h3>
          <div class="stat"><div>Puntos</div><strong id="myPoints">0</strong></div>
          <div class="stat"><div>Depósitos</div><strong id="myDeposits">0</strong></div>
          <div id="challengeBox" class="challenge hidden">
            <h4>Reto semanal</h4>
            <div class="progress"><div id="ch-progress"></div></div>
            <small id="ch-text"></small>
          </div>
          <button class="btn" id="btn-edit-profile">Editar perfil</button>
        </div>
      </div>
    </section>

    <section id="view-challenges" class="card hidden">
      <h2>Retos</h2>
      <div id="challenge-info" class="card soft"></div>
    </section>

    <section id="view-ranking" class="card hidden">
      <h2>Rankings</h2>
      <div class="tabs">
        <button class="tab active" data-tab="student">Estudiantes</button>
        <button class="tab" data-tab="class">Clases</button>
        <button class="tab" data-tab="group">Grupos</button>
      </div>
      <div id="rank-student"></div>
      <div id="rank-class" class="hidden"></div>
      <div id="rank-group" class="hidden"></div>
    </section>

    <section id="view-rewards" class="card hidden">
      <h2>Tienda Verde</h2>
      <div id="rewards-list" class="list"></div>
    </section>

    <section id="view-learn" class="card hidden">
      <h2>Aprende y Actúa</h2>
      <div class="content-grid" id="content-list"></div>
    </section>

    <section id="view-admin" class="card hidden">
      <h2>Panel Docente</h2>
      <div class="form-row">
        <label>Clave docente <input id="admin-key" type="password" placeholder="••••"></label>
        <button class="btn" id="btn-admin-login">Entrar</button>
      </div>
      <div id="admin-area" class="hidden">
        <div class="grid-2">
          <div class="card soft">
            <h3>Estadísticas</h3>
            <div id="kpi-total"></div>
            <div id="chart-by-mat" style="height:280px"></div>
            <h4>Top estudiantes</h4>
            <div id="top-students"></div>
            <h4>Top clases</h4>
            <div id="top-classes"></div>
          </div>
          <div class="card soft">
            <h3>Acciones</h3>
            <button class="btn" id="btn-export">Exportar CSV</button>
            <button class="btn" id="btn-roll-challenge">Nueva semana (reto)</button>
            <small class="muted">Usa esto al iniciar la semana escolar.</small>
          </div>
        </div>
      </div>
    </section>

    <div id="scanner-modal" class="scanner-modal hidden" role="dialog" aria-modal="true" aria-labelledby="scanner-title">
      <div class="scanner-dialog">
        <header>
          <h3 id="scanner-title">Escanear código QR</h3>
          <button class="btn icon-only" id="btn-close-scanner" aria-label="Cerrar escáner">✕</button>
        </header>
        <p>Mantén estable tu dispositivo y apunta al QR dentro del marco. Puedes cambiar de cámara si lo necesitas.</p>
        <div class="scanner-controls">
          <label for="camera-select">Cámara
            <select id="camera-select"></select>
          </label>
          <button class="btn secondary hidden" type="button" id="btn-toggle-torch">Linterna</button>
        </div>
        <div id="qr-reader" class="qr-view">
          <div class="qr-overlay"></div>
        </div>
        <div id="scanner-status" class="scanner-status" role="status" aria-live="polite"></div>
        <div class="scanner-actions">
          <button class="btn secondary" type="button" id="btn-stop-scanner">Detener</button>
          <button class="btn" type="button" id="btn-help-scanner">¿Problemas con la cámara?</button>
        </div>
      </div>
    </div>

    <nav class="nav">
      <button class="nav-btn" data-go="view-home"><span class="icon">🏠</span><span class="label">Inicio</span></button>
      <button class="nav-btn" data-go="view-challenges"><span class="icon">🎯</span><span class="label">Retos</span></button>
      <button class="nav-btn" data-go="view-ranking"><span class="icon">🏆</span><span class="label">Ranking</span></button>
      <button class="nav-btn" data-go="view-rewards"><span class="icon">🎁</span><span class="label">Recompensas</span></button>
      <button class="nav-btn" data-go="view-learn"><span class="icon">💡</span><span class="label">Aprende</span></button>
      <button class="nav-btn" data-go="view-admin"><span class="icon">🧑‍🏫</span><span class="label">Docentes</span></button>
    </nav>
  </main>

  <script>
    function $(s){ return document.querySelector(s); }
    function $$(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }

    var html5Scanner = null;
    var profile = null;
    var navButtons = $$('.nav-btn');

    function show(id){
      ['view-register','view-home','view-challenges','view-ranking','view-rewards','view-learn','view-admin']
        .forEach(function(v){ document.getElementById(v).classList.toggle('hidden', v !== id); });
      navButtons.forEach(function(btn){ btn.classList.toggle('active', btn.dataset.go === id); });
    }

    navButtons.forEach(function(btn){
      btn.addEventListener('click', function(){
        var id = btn.dataset.go;
        if (id === 'view-home' && !profile) return show('view-register');
        show(id);
        if (id === 'view-challenges') loadChallenges();
        if (id === 'view-ranking') loadRanking();
        if (id === 'view-rewards') loadRewards();
        if (id === 'view-learn') loadContent();
      });
    });

    function loadProfileFromLocal() {
      try { profile = JSON.parse(localStorage.getItem('recycle_profile') || 'null'); } catch(e){ profile = null; }
    }
    function saveProfileLocal(p) { localStorage.setItem('recycle_profile', JSON.stringify(p)); }
    function finishProfileSetup(p, notice){
      profile = p;
      saveProfileLocal(profile);
      hydrateHome();
      show('view-home');
      if (notice) {
        setTimeout(function(){ alert(notice); }, 60);
      }
    }

    $('#btn-save-profile').addEventListener('click', function(){
      var p = {
        studentId: $('#reg-id').value.trim(),
        name: $('#reg-name').value.trim(),
        group: $('#reg-group').value.trim(),
        className: $('#reg-class').value.trim(),
        email: $('#reg-email').value.trim()
      };
      if (!p.studentId || !p.name || !p.group || !p.className) {
        alert('Completa ID, Nombre, Grupo y Clase');
        return;
      }
      google.script.run
        .withSuccessHandler(function(st){
          if (!st || st.ok === false) {
            console.warn('Fallo al sincronizar perfil, usando almacenamiento local.', st);
            finishProfileSetup(p, 'No pudimos sincronizar con la nube, pero tu perfil quedó guardado en este dispositivo.');
            return;
          }
          finishProfileSetup(p);
        })
        .withFailureHandler(function(err){
          console.warn('Error guardando perfil, se continúa en modo local.', err);
          finishProfileSetup(p, 'No pudimos conectar con el servidor, pero tu perfil quedó guardado en este dispositivo.');
        })
        .upsertStudent(p);
    });

    $('#btn-edit-profile').addEventListener('click', function(){
      $('#reg-id').value = profile.studentId;
      $('#reg-name').value = profile.name;
      $('#reg-group').value = profile.group;
      $('#reg-class').value = profile.className;
      $('#reg-email').value = profile.email || '';
      show('view-register');
    });

    function hydrateHome(){
      $('#studentName').textContent = (profile && profile.name) ? profile.name : 'Estudiante';
      google.script.run.withSuccessHandler(function(res){
        if (!res || !res.ok) return;
        $('#myPoints').textContent = res.points;
        $('#myDeposits').textContent = res.deposits;
        if (res.challenge) {
          var goal = res.challenge.goal, done = res.challenge.done, start = res.challenge.start, end = res.challenge.end, bonus = res.challenge.bonus;
          var pct = Math.min(100, Math.round((done/goal)*100));
          $('#ch-progress').style.width = pct + '%';
          $('#ch-text').textContent = 'Lleva ' + done + '/' + goal + '. Semana ' + start + ' a ' + end + '. Bono +' + bonus + ' pts.';
          $('#challengeBox').classList.remove('hidden');
        } else {
          $('#challengeBox').classList.add('hidden');
        }
      }).getMySummary(profile.studentId);
    }

    var scannerModal = $('#scanner-modal');
    var cameraSelect = $('#camera-select');
    var scannerStatusEl = $('#scanner-status');
    var torchBtn = $('#btn-toggle-torch');
    var stopScannerBtn = $('#btn-stop-scanner');
    var closeScannerBtn = $('#btn-close-scanner');
    var helpScannerBtn = $('#btn-help-scanner');
    var availableCameras = [];
    var currentCameraId = null;
    var torchSupported = false;
    var torchEnabled = false;
    var isScannerActive = false;
    var rankingTabsInitialized = false;

    function setScannerStatus(msg, isError){
      if (!scannerStatusEl) return;
      scannerStatusEl.textContent = msg || '';
      scannerStatusEl.style.color = isError ? '#b3261e' : 'var(--muted)';
    }

    function ensureScannerInstance(){
      if (html5Scanner) return Promise.resolve(html5Scanner);
      var opts = window.Html5QrcodeSupportedFormats ? { formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE] } : {};
      html5Scanner = new Html5Qrcode('qr-reader', opts);
      return Promise.resolve(html5Scanner);
    }

    function stopScanner(){
      if (!html5Scanner) return Promise.resolve();
      var toStop = html5Scanner.stop ? html5Scanner.stop() : Promise.resolve();
      return Promise.resolve(toStop)
        .catch(function(){})
        .then(function(){ if (html5Scanner && html5Scanner.clear) { return Promise.resolve(html5Scanner.clear()).catch(function(){}); } })
        .finally(function(){
          html5Scanner = null;
          torchSupported = false;
          torchEnabled = false;
          isScannerActive = false;
          updateTorchButton();
        });
    }

    function formatCameraLabel(device, index){
      var label = device.label || ('Cámara ' + (index + 1));
      var lowered = (device.label || '').toLowerCase();
      if (lowered.indexOf('back') !== -1 || lowered.indexOf('rear') !== -1 || lowered.indexOf('environment') !== -1) label += ' (trasera)';
      else if (lowered.indexOf('front') !== -1 || lowered.indexOf('user') !== -1) label += ' (frontal)';
      return label;
    }

    function listCameras(){
      if (!cameraSelect) return Promise.reject(new Error('No se encontró el selector de cámara.'));
      return Html5Qrcode.getCameras().then(function(devices){
        availableCameras = devices || [];
        if (!availableCameras.length) throw new Error('No se detectaron cámaras disponibles.');
        cameraSelect.innerHTML = availableCameras.map(function(dev, i){
          return '<option value="' + dev.id + '">' + formatCameraLabel(dev, i) + '</option>';
        }).join('');
        var preferred = availableCameras.find(function(dev){
          var label = (dev.label || '').toLowerCase();
          return label.indexOf('back') !== -1 || label.indexOf('rear') !== -1 || label.indexOf('environment') !== -1;
        }) || availableCameras[0];
        currentCameraId = preferred.id;
        cameraSelect.value = currentCameraId;
        cameraSelect.disabled = availableCameras.length === 1;
      });
    }

    function updateTorchButton(){
      if (!torchBtn) return;
      torchBtn.disabled = !torchSupported;
      torchBtn.classList.toggle('hidden', !torchSupported);
      torchBtn.textContent = torchEnabled ? 'Apagar linterna' : 'Linterna';
    }

    function updateTorchAvailability(){
      if (!html5Scanner || typeof html5Scanner.getRunningTrackCapabilities !== 'function') {
        torchSupported = false;
        updateTorchButton();
        return;
      }
      html5Scanner.getRunningTrackCapabilities()
        .then(function(cap){
          torchSupported = !!(cap && cap.torch);
          if (!torchSupported) torchEnabled = false;
          updateTorchButton();
        })
        .catch(function(){
          torchSupported = false;
          torchEnabled = false;
          updateTorchButton();
        });
    }

    function toggleTorch(){
      if (!torchSupported || !html5Scanner) return;
      var action = null;
      if (!torchEnabled && typeof html5Scanner.turnOnTorch === 'function') action = html5Scanner.turnOnTorch();
      else if (torchEnabled && typeof html5Scanner.turnOffTorch === 'function') action = html5Scanner.turnOffTorch();
      else if (typeof html5Scanner.applyVideoConstraints === 'function') action = html5Scanner.applyVideoConstraints({ advanced: [{ torch: !torchEnabled }] });
      if (!action) return;
      Promise.resolve(action)
        .then(function(){
          torchEnabled = !torchEnabled;
          updateTorchButton();
        })
        .catch(function(){ setScannerStatus('No pudimos controlar la linterna en este dispositivo.', true); });
    }

    function computeQrBox(viewWidth, viewHeight){
      var minEdge = Math.min(viewWidth, viewHeight);
      var size = Math.round(minEdge * 0.7);
      return { width: size, height: size };
    }

    function startScanner(cameraId){
      return stopScanner().then(function(){
        return ensureScannerInstance().then(function(scanner){
          var config = {
            fps: 12,
            qrbox: function(w, h){ return computeQrBox(w, h); },
            aspectRatio: 1.0,
            disableFlip: true,
            experimentalFeatures: { useBarCodeDetectorIfSupported: true }
          };
          setScannerStatus('Abriendo cámara...', false);
          return scanner.start(
            cameraId,
            config,
            onScanSuccess,
            function(){ if (!isScannerActive) setScannerStatus('Escaneando...', false); }
          ).then(function(){
            currentCameraId = cameraId;
            isScannerActive = true;
            setScannerStatus('Escaneando... Apunta al QR dentro del marco.', false);
            updateTorchAvailability();
          }).catch(function(err){
            setScannerStatus('No se pudo iniciar la cámara. Usa "Registrar sin QR".', true);
            feedback('No se pudo iniciar la cámara. Usa "Registrar sin QR".', true);
            throw err;
          });
        });
      });
    }

    function openScannerModal(){
      if (!profile) return show('view-register');
      document.body.classList.add('modal-open');
      if (scannerModal) scannerModal.classList.remove('hidden');
      setScannerStatus('Preparando cámara...', false);
      torchSupported = false;
      torchEnabled = false;
      updateTorchButton();
      listCameras()
        .then(function(){ return startScanner(currentCameraId); })
        .catch(function(err){
          setScannerStatus(err && err.message ? err.message : 'No se detectaron cámaras.', true);
          feedback('No se pudo iniciar la cámara. Usa "Registrar sin QR".', true);
        });
    }

    function closeScannerModal(){
      document.body.classList.remove('modal-open');
      if (scannerModal) scannerModal.classList.add('hidden');
      setScannerStatus('');
      stopScanner();
    }

    function switchCamera(cameraId){
      if (!cameraId || cameraId === currentCameraId) return;
      setScannerStatus('Cambiando de cámara...', false);
      startScanner(cameraId).catch(function(){ setScannerStatus('No se pudo cambiar de cámara. Intenta con otra opción.', true); });
    }

    function onScanSuccess(decodedText){
      if (!isScannerActive) return;
      isScannerActive = false;
      var count = Number($('#deposit-count').value || 1);
      registerDeposit(decodedText, count);
      closeScannerModal();
    }

    $('#btn-open-scanner').addEventListener('click', openScannerModal);
    if (torchBtn) torchBtn.addEventListener('click', toggleTorch);
    if (stopScannerBtn) stopScannerBtn.addEventListener('click', closeScannerModal);
    if (closeScannerBtn) closeScannerBtn.addEventListener('click', closeScannerModal);
    if (helpScannerBtn) helpScannerBtn.addEventListener('click', function(){
      alert('Consejos: 1) Revisa permisos de cámara del navegador. 2) Cambia de cámara desde el selector si ves la imagen en negro. 3) Mantén el QR dentro del marco y evita reflejos.');
    });
    if (scannerModal) {
      scannerModal.addEventListener('click', function(ev){ if (ev.target === scannerModal) closeScannerModal(); });
    }
    document.addEventListener('keydown', function(ev){ if (ev.key === 'Escape' && scannerModal && !scannerModal.classList.contains('hidden')) closeScannerModal(); });
    if (cameraSelect) cameraSelect.addEventListener('change', function(){ switchCamera(cameraSelect.value); });

    $('#btn-log-manual').addEventListener('click', function(){
      var count = Number($('#deposit-count').value || 1);
      var fakeQR = 'RCP|PLASTICO|MANUAL|ESCUELA-001';
      registerDeposit(fakeQR, count);
    });

    function feedback(msg, isError){
      var box = $('#feedback');
      box.textContent = msg;
      box.style.color = isError ? '#b3261e' : '#0b6b3a';
      box.classList.toggle('toast-success', !isError && !!msg);
    }

    function registerDeposit(qrText, count){
      if (!profile) return show('view-register');
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) return feedback(res && res.error ? res.error : 'Error al registrar', true);
          feedback('Registrado: +' + res.pointsAwarded + ' pts');
          hydrateHome();
        })
        .withFailureHandler(function(err){
          var msg = (err && err.message) ? err.message : JSON.stringify(err);
          feedback('Error: ' + msg, true);
        })
        .logRecycling({ qrText: qrText, studentId: profile.studentId, count: count });
    }

    function loadChallenges(){
      var box = document.getElementById('challenge-info');
      box.innerHTML = '<p class="muted">Cargando...</p>';
      google.script.run.withSuccessHandler(function(res){
        if (!res || !res.ok) {
          box.innerHTML = '<p class="muted">No hay retos activos por ahora.</p>';
          return;
        }
        var ch = res.challenge;
        var status = '' +
          '<h3>' + ch.title + '</h3>' +
          '<p><strong>Objetivo:</strong> ' + ch.goal + ' depósitos entre el ' + ch.start + ' y el ' + ch.end + '.</p>' +
          '<p><strong>Bono:</strong> +' + ch.bonus + ' pts por completar el reto.</p>' +
          (ch.description ? '<p>' + ch.description + '</p>' : '') +
          '<small class="muted">Última actualización: ' + ch.updatedAt + '</small>';
        box.innerHTML = status;
      }).getActiveChallenge();
    }

    function loadRanking(){
      google.script.run.withSuccessHandler(function(list){ renderRank('#rank-student', list, 'Estudiante'); }).getLeaderboard('student');
      google.script.run.withSuccessHandler(function(list){ renderRank('#rank-class', list, 'Clase'); }).getLeaderboard('class');
      google.script.run.withSuccessHandler(function(list){ renderRank('#rank-group', list, 'Grupo'); }).getLeaderboard('group');

      if (!rankingTabsInitialized) {
        $$('.tab').forEach(function(t){
          t.addEventListener('click', function(){
            $$('.tab').forEach(function(x){ x.classList.remove('active'); });
            t.classList.add('active');
            $('#rank-student').classList.add('hidden');
            $('#rank-class').classList.add('hidden');
            $('#rank-group').classList.add('hidden');
            document.getElementById('rank-'+t.dataset.tab).classList.remove('hidden');
          });
        });
        rankingTabsInitialized = true;
      }
    }
    function renderRank(sel, list, label){
      var el = document.querySelector(sel);
      if (!list || !list.length) { el.innerHTML = '<p class="muted">Sin datos todavía.</p>'; return; }
      var rows = list.map(function(r,i){
        var left = label==='Estudiante'
          ? (i+1) + '. ' + r.name + ' <small class="muted">(' + (r.class || r.group || r.id) + ')</small>'
          : (label==='Clase' ? (i+1) + '. ' + r.class : (i+1) + '. ' + r.group);
        return '<div class="stat"><div>' + left + '</div><strong>' + r.points + ' pts</strong></div>';
      }).join('');
      el.innerHTML = rows;
    }

    function loadRewards(){
      google.script.run.withSuccessHandler(function(list){
        if (!list.length) { $('#rewards-list').innerHTML = '<p class="muted">Sin recompensas activas.</p>'; return; }
        $('#rewards-list').innerHTML = list.map(function(r){
          return '' +
          '<div class="card-item">' +
            '<h4>' + r.Name + '</h4>' +
            '<small>' + (r.Description || '') + '</small>' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">' +
              '<span><strong>' + r.CostPoints + '</strong> pts</span>' +
              '<button class="btn" data-rid="' + r.RewardID + '">Canjear</button>' +
            '</div>' +
          '</div>';
        }).join('');
        $$('#rewards-list .btn').forEach(function(b){
          b.addEventListener('click', function(){
            if (!profile) return show('view-register');
            var rid = b.dataset.rid;
            var who = 'Docente';
            google.script.run
              .withSuccessHandler(function(res){
                if (!res || !res.ok) return alert(res && res.error ? res.error : 'No se pudo canjear');
                alert('Listo. Nuevo saldo: ' + res.newBalance + ' pts');
                hydrateHome();
              })
              .withFailureHandler(function(err){ alert('Error en canje: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
              .redeemReward(profile.studentId, rid, who);
          });
        });
      }).listRewards();
    }

    function loadContent(){
      google.script.run.withSuccessHandler(function(list){
        if (!list.length) { $('#content-list').innerHTML = '<p class="muted">Pronto agregaremos consejos.</p>'; return; }
        $('#content-list').innerHTML = list.map(function(c){
          return '' +
          '<div class="content">' +
            '<strong>' + (c.Category === 'tip' ? 'Consejo' : 'Dato') + ':</strong>' +
            '<h4 style="margin:.25rem 0 .5rem">' + c.Title + '</h4>' +
            '<p>' + (c.Body || '') + '</p>' +
          '</div>';
        }).join('');
      }).getContent('all');
    }

    $('#btn-admin-login').addEventListener('click', function(){
      var key = $('#admin-key').value.trim();
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) return alert(res && res.error ? res.error : 'No autorizado');
          $('#admin-area').classList.remove('hidden');
          renderAdmin(res);
        })
        .withFailureHandler(function(err){ alert('Error de panel: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
        .getDashboardStats(key);
    });
    function renderAdmin(stats){
      $('#kpi-total').innerHTML = '<div class="stat"><div>Depósitos registrados</div><strong>' + stats.totalDeposits + '</strong></div>';
      if (window.google && google.charts) {
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(function(){
          var data = new google.visualization.DataTable();
          data.addColumn('string','Material');
          data.addColumn('number','Cantidad');
          var keys = Object.keys(stats.byMaterial || {});
          if (keys.length === 0) data.addRows([['PLASTICO', 0]]);
          else {
            var rows = keys.map(function(k){ return [k, Number(stats.byMaterial[k] || 0)]; });
            data.addRows(rows);
          }
          var chart = new google.visualization.PieChart(document.getElementById('chart-by-mat'));
          chart.draw(data, {pieHole:0.5, legend:{position:'bottom'}});
        });
      }
      $('#top-students').innerHTML = stats.topStudents.map(function(r,i){
        return '<div class="stat"><div>'+(i+1)+'. '+r.name+'</div><strong>'+r.points+' pts</strong></div>';
      }).join('');
      $('#top-classes').innerHTML = stats.topClasses.map(function(r,i){
        return '<div class="stat"><div>'+(i+1)+'. '+r.class+'</div><strong>'+r.points+' pts</strong></div>';
      }).join('');
    }
    $('#btn-export').addEventListener('click', function(){
      var key = $('#admin-key').value.trim();
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) return alert(res && res.error ? res.error : 'No se pudo exportar');
          alert('CSV creado. Ábrelo desde Drive:\n' + res.url);
        })
        .withFailureHandler(function(err){ alert('Error exportando CSV: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
        .exportCSV(key);
    });
    $('#btn-roll-challenge').addEventListener('click', function(){
      var ok = confirm('Esto cerrará el reto activo y creará el de la semana actual. ¿Continuar?');
      if (!ok) return;
      google.script.run
        .withSuccessHandler(function(){ alert('Reto semanal creado/actualizado.'); })
        .withFailureHandler(function(err){ alert('Error creando reto: ' + ((err && err.message) ? err.message : JSON.stringify(err))); })
        .rollWeeklyChallenge();
    });

    (function(){
      var s = <?!= JSON.stringify(initial.settings) ?>;
      document.getElementById('schoolName').textContent = s.SCHOOL_NAME || 'Recicla App';
      document.documentElement.style.setProperty('--primary', s.PRIMARY_COLOR || '#eb1946');
      document.documentElement.style.setProperty('--secondary', s.SECONDARY_COLOR || '#01263b');
    })();

    window.addEventListener('load', function(){
      loadProfileFromLocal();
      if (profile) { hydrateHome(); show('view-home'); }
      else { show('view-register'); }
    });
    
  </script>
</body>
</html>
